# Implementation Plan: Recurring Tasks & Smart Reminders

**Branch**: `006-recurring-reminders` | **Date**: 2026-01-23 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/006-recurring-reminders/spec.md`

## Summary

This feature adds two major capabilities to the Todo application:
1. **Recurring Tasks**: Users can create todos that automatically regenerate on a schedule (daily, weekly, monthly, yearly, or custom RRULE patterns). Uses python-dateutil for RFC 5545 compliant recurrence calculation with a hybrid occurrence generation strategy (materialize 30 days + on-demand).
2. **Smart Reminders & Notifications**: Users can set time-based reminders that trigger browser push notifications and appear in an in-app notification center. Uses Web Push API with VAPID authentication and APScheduler for server-side reminder scheduling.

## Technical Context

**Language/Version**: Python 3.12 (Backend), TypeScript 5.6+ (Frontend)
**Primary Dependencies**:
- Backend: FastAPI 0.100+, SQLModel, python-dateutil, pywebpush, APScheduler
- Frontend: Next.js 16.0.10, React 19.x, Tailwind CSS 3.4+
**Storage**: Neon Serverless PostgreSQL (new tables: todo_occurrences, reminders, notifications, push_subscriptions, user_preferences)
**Testing**: Pytest (Backend), Vitest/Playwright (Frontend)
**Target Platform**: Web browsers with Push API support (Chrome, Firefox, Edge, Safari 16+)
**Project Type**: Web application (frontend + backend)
**Performance Goals**:
- Reminders fire within 1 minute of scheduled time (95th percentile)
- Notification center loads < 1 second with 100+ notifications
- Support 100 active recurring todos per user
**Constraints**:
- Maximum 5 reminders per todo
- Notifications auto-delete after 30 days
- HTTPS required for push notifications
**Scale/Scope**: Existing user base from SPEC-002, 12 user stories, 23 functional requirements

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development | ✅ PASS | Full spec.md with 12 user stories, 23 FRs |
| II. Agentic Separation | ✅ PASS | Backend handles recurrence/reminders, Frontend handles UI/push subscription |
| III. Security-First | ✅ PASS | JWT required for all APIs, user_id on all tables, VAPID for push |
| IV. API Contract Stability | ✅ PASS | Contracts defined in contracts/*.yaml |
| V. Stateless Auth (JWT) | ✅ PASS | Continues using Better Auth JWT |
| VI. Persistent Data Ownership | ✅ PASS | All new tables include user_id |
| VII. Simplicity | ✅ PASS | Using standard libraries (dateutil, pywebpush), minimal custom code |
| VIII. Observable Resilience | ✅ PASS | Structured logging planned for reminder/notification services |
| IX. Deployment Integrity | ⚠️ PENDING | E2E tests to be added during implementation |

## Project Structure

### Documentation (this feature)

```text
specs/006-recurring-reminders/
├── plan.md              # This file
├── spec.md              # Feature requirements
├── research.md          # Technical research decisions
├── data-model.md        # Entity definitions and schemas
├── quickstart.md        # Implementation guide
├── contracts/           # API contracts
│   ├── recurring-todos-api.yaml
│   ├── reminders-api.yaml
│   ├── notifications-api.yaml
│   └── preferences-api.yaml
├── checklists/
│   └── requirements.md  # Requirements validation
└── tasks.md             # Implementation tasks (generated by /sp.tasks)
```

### Source Code (repository root)

```text
backend/
├── app/
│   ├── models/
│   │   ├── todo.py              # Extended with recurrence fields
│   │   ├── occurrence.py        # NEW: TodoOccurrence model
│   │   ├── reminder.py          # NEW: Reminder model
│   │   ├── notification.py      # NEW: Notification model
│   │   ├── push_subscription.py # NEW: PushSubscription model
│   │   └── user_preferences.py  # NEW: UserPreferences model
│   ├── routers/
│   │   ├── todos.py             # Extended for recurrence
│   │   ├── occurrences.py       # NEW: Occurrence endpoints
│   │   ├── reminders.py         # NEW: Reminder endpoints
│   │   ├── notifications.py     # NEW: Notification endpoints
│   │   └── push.py              # NEW: Push subscription endpoints
│   ├── services/
│   │   ├── recurrence.py        # NEW: RRULE generation/calculation
│   │   ├── reminder.py          # NEW: Reminder scheduling
│   │   └── notification.py      # NEW: Push notification sending
│   └── scheduler.py             # NEW: APScheduler setup
└── tests/
    ├── test_recurring.py        # NEW
    ├── test_reminders.py        # NEW
    └── test_notifications.py    # NEW

frontend/
├── public/
│   └── sw.js                    # NEW: Service worker for push
├── src/
│   ├── components/
│   │   ├── todos/
│   │   │   ├── RecurrenceSelector.tsx    # NEW
│   │   │   ├── ReminderSelector.tsx      # NEW
│   │   │   └── RecurringIndicator.tsx    # NEW
│   │   └── notifications/
│   │       ├── NotificationCenter.tsx    # NEW
│   │       ├── NotificationBell.tsx      # NEW
│   │       └── NotificationItem.tsx      # NEW
│   ├── hooks/
│   │   ├── useNotifications.ts           # NEW
│   │   └── usePushSubscription.ts        # NEW
│   ├── services/
│   │   └── push.ts                       # NEW
│   └── types/
│       ├── recurrence.ts                 # NEW
│       ├── reminder.ts                   # NEW
│       └── notification.ts               # NEW
└── tests/
    └── recurring-reminders.spec.ts       # NEW: E2E tests
```

**Structure Decision**: Web application with existing backend/frontend structure. New models, routers, and services added to backend. New components and hooks added to frontend. Service worker added to public/ for push notification handling.

## Key Design Decisions

### 1. Recurrence Storage: RRULE Strings (RFC 5545)
- **Decision**: Store recurrence as RRULE strings in the Todo model
- **Rationale**: Industry standard, interoperable, well-supported by python-dateutil
- **Alternative Rejected**: Custom fields (less flexible, reinventing the wheel)

### 2. Occurrence Generation: Hybrid Strategy
- **Decision**: Materialize 30 days of occurrences + generate on-demand
- **Rationale**: Balances query performance with storage efficiency
- **Alternative Rejected**: Pure virtual (expensive queries) or pure materialized (unbounded storage)
- **ADR**: [ADR-001: Hybrid Occurrence Generation](../../history/adr/ADR-001-hybrid-occurrence-generation.md)

### 3. Push Notifications: Web Push API + VAPID
- **Decision**: Use native Web Push API with pywebpush backend
- **Rationale**: No external service dependency, standard protocol
- **Alternative Rejected**: OneSignal/Pusher (cost, dependency)

### 4. Reminder Scheduling: APScheduler with PostgreSQL Job Store
- **Decision**: Use APScheduler for background reminder firing
- **Rationale**: Lightweight, FastAPI-compatible, database-backed for persistence
- **Alternative Rejected**: Celery (overkill for this use case)

### 5. Service Worker: Minimal, Push-Only
- **Decision**: Create minimal service worker only for push event handling
- **Rationale**: Next.js doesn't have native SW support; keep scope limited
- **Alternative Rejected**: Full PWA (out of scope)

## Complexity Tracking

No constitution violations requiring justification.

## Implementation Phases

### Phase 1: Backend Models & Migrations (P1)
- Add recurrence fields to Todo model
- Create TodoOccurrence, Reminder, Notification, PushSubscription, UserPreferences models
- Generate and run Alembic migrations
- Add database indexes for query performance

### Phase 2: Backend Services (P1)
- Implement RecurrenceService (RRULE parsing, occurrence generation)
- Implement ReminderService (scheduling, firing logic)
- Implement NotificationService (push sending, in-app creation)
- Set up APScheduler integration

### Phase 3: Backend APIs (P1)
- Extend POST/PATCH /todos for recurrence
- Add occurrence endpoints (list, complete, skip)
- Add reminder endpoints (CRUD, snooze)
- Add notification endpoints (list, mark read)
- Add push subscription endpoints

### Phase 4: Frontend Core (P1)
- Create RecurrenceSelector component
- Create ReminderSelector component
- Create NotificationCenter and NotificationBell components
- Add recurring indicator to TodoItem
- Implement useNotifications and usePushSubscription hooks

### Phase 5: Push Infrastructure (P1)
- Create service worker (public/sw.js)
- Implement permission request flow
- Handle notification click navigation
- Integrate with backend push endpoints

### Phase 6: Advanced Features (P2)
- Edit "this occurrence only" vs "all future"
- Snooze reminder functionality
- User preferences (timezone, default reminder)
- Custom recurrence patterns UI

### Phase 7: Polish (P3)
- Daily digest implementation
- End recurring series UI
- Mobile-responsive notification center
- Accessibility improvements (ARIA, keyboard navigation)

## Dependencies

### External
- **SPEC-002**: Authentication (user identity) - ✅ Complete
- **SPEC-005**: Todo Enhancements (due dates) - ✅ Complete

### New Python Packages
```
python-dateutil>=2.8.2    # RRULE support
pywebpush>=1.14.0         # Web Push notifications
APScheduler>=3.10.4       # Background scheduling
```

### Environment Variables
```env
VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...
VAPID_CLAIMS_EMAIL=mailto:...
```

## Risk Analysis

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Push notification browser compatibility | Medium | Medium | Graceful fallback to in-app notifications only |
| Reminder timing drift under load | Low | Medium | APScheduler misfire_grace_time + monitoring |
| Complex RRULE edge cases | Medium | Low | Comprehensive test suite, use python-dateutil (well-tested) |

## Success Criteria Mapping

| Spec Criteria | Implementation Approach |
|---------------|------------------------|
| SC-001: Create recurring todo < 30s | Simple UI, server-side RRULE generation |
| SC-002: 95% reminders within 1 min | APScheduler with PostgreSQL job store |
| SC-003: 2-click notification access | Header notification bell component |
| SC-004: No extra clicks for recurring | Complete button works same as regular todos |
| SC-005: Daily digest within 5 min | Dedicated scheduled job at user's preferred time |
| SC-006: 100 recurring todos/user | Indexed queries, pagination |
| SC-007: Notification center < 1s | Indexed queries, limit + offset pagination |

## Next Steps

Run `/sp.tasks` to generate implementation tasks from this plan.
